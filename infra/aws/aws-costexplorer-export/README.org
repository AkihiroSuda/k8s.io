#+TITLE: AWS CostExplorer Export

* Introduction
In the k8s-infra community, data for billing on projects in the org is collated into a billing report which is viewed each meeting.
Currently that data is only pulled from the GCP org.

* Goal
- Pull in CostExplorer usage & cost data for the last year
- Prepare it
  - Transform the data if need be
  - Marshal as JSON
- Upload the JSON data into a bucket

* Operation
- Get a CostExplorer client through AWS SDK
- Fetch the usage data
- Prepare usage data
  - Marshal usage data as JSON
- Open a connection to a bucket (GCS Bucket)
- Upload prepared data to the bucket
  - using latest name
  - using name based on date+time

* Preparation
** Log into AWS
Configure the local CLI for access
#+begin_src tmate :window aws-costexplorer-export
aws configure
#+end_src

NOTE: An org-level root account or IAM account with CostExplorer access is required

** Log into GCP
Account log in
#+begin_src tmate :window aws-costexplorer-export
gcloud auth login
#+end_src

Set the project to /k8s-infra-ii-sandbox/
#+begin_src tmate :window aws-costexplorer-export
gcloud config set project k8s-infra-ii-sandbox
#+end_src

Log into application-default CloudSDK
#+begin_src tmate :window aws-costexplorer-export
gcloud auth application-default login
#+end_src

* Usage
#+begin_src shell
go run .
#+end_src

** Flags
| Name               | Default                                               | Description                                            |
| aws-region         | us-east-1                                             | region for AWS SDK to use                              |
| output-file        | /tmp/local-cncf-aws-infra-billing-and-usage-data.json | a temporary location to write the usage data           |
| output-file-enable | false                                                 | whether the usage data is also written to disk locally |
| bucket-uri         | gs://cncf-aws-infra-cost-and-billing-data             | the bucket to upload the json blobs to                 |
| days-back          | 365                                                   | the amount of days back to report from today           |
| promote-to-latest  | true                                                  | promotes the cost and usage data to a latest JSON file |

* Testing
Use an in-memory S3 style bucket and write the usage data also to local disk
#+begin_src shell
go run . \
    --bucket-uri "mem://" \
    --output-file-enable=true
#+end_src

* Build an image
Produce a container image using ko
#+begin_src tmate :window aws-costexplorer-export
ko publish --local .
#+end_src
